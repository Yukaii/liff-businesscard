<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"><title>分享 LINE 數位版名片</title><script>(function () {
  const hostname = location.host.split(':')[0]
  if (hostname === 'localhost') document.write(`<script src="http://${hostname}:35729/livereload.js?snipver=1"></` + 'script>')
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-default@3/default.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&amp;display=swap"><style>body, .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
  font-family: 'Noto Sans TC', sans-serif; }
</style><meta property="fb:app_id" content="2133031763635285"><meta property="og:description" content="請開啟本連結並按一下「選擇分享對象」來透過 LINE 分享名片"><meta property="og:image:height" content="315"><meta property="og:image:width" content="600"><meta property="og:image" content="https://i.imgur.com/PqLcIKj.png"><meta property="og:locale" content="zh_TW"><meta property="og:site_name" content="筆記國度"><meta property="og:title" content="分享 LINE 數位版名片"><meta property="og:type" content="website"><meta property="og:url" content="https://taichunmin.idv.tw/liff-businesscard/share.html"><style>[v-cloak] {
  display: none; }
</style></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-12"></script><script>/* global sleep */
window.dataLayer = window.dataLayer || []
function gtag () { window.dataLayer.push(arguments) }
window.gtagStartTime = new Date()
gtag('js', window.gtagStartTime)
gtag('config', 'UA-39556213-3')
gtag('config', 'UA-39556213-12', {
  app_name: 'LINE 數位版名片網站',
  send_page_view: false,
  transport_type: 'beacon',
})
window.gtagEvent = (category, action, label, value = 1) => new Promise(resolve => {
  gtag('event', action, {
    event_callback: resolve,
    event_category: category,
    event_label: label,
    value,
  })
})
window.gtagScreenView = screenName => new Promise(resolve => {
  gtag('event', 'screen_view', {
    event_callback: resolve,
    screen_name: screenName,
  })
})
window.gtagError = async (err, fatal = false) => new Promise(resolve => {
  gtag('event', 'exception', {
    description: err.message || '',
    event_callback: resolve,
    fatal,
  })
})
window.gtagTiming = async (name) => new Promise(resolve => {
  gtag('event', 'timing_complete', {
    event_callback: resolve,
    event_category: location.pathname,
    name,
    value: new Date() - window.gtagStartTime,
  })
})
window.gtagSetLineId = async lineId => {
  while (!window.liff) { // 如果沒有 window.liff 就隔一段時間檢查一次
    await sleep(2000)
  }
  await liff.ready
  const config = {
    app_name: `LIFF ${liff.getOS()}`,
    send_page_view: false,
    transport_type: 'beacon',
  }
  const profile = await liff.getProfile()
  if (liff.isInClient()) config.app_version = liff.getLineVersion()
  if (_.hasIn(profile, 'userId')) config.user_id = profile.userId
  gtag('config', 'UA-39556213-12', config)
}</script><div class="container my-4 text-monospace" id="app" v-cloak><h1 class="my-3 text-center">分享 LINE 數位版名片</h1><div id="share" v-if="page === 'share'"><p>請按一下「選擇分享對象」來透過 LINE 分享名片吧！</p><button class="btn btn-lg btn-success btn-block my-2" type="button" @click="btnShare">選擇分享對象</button><button class="btn btn-lg btn-info btn-block my-2" type="button" @click="btnSend">傳送到目前聊天視窗</button><div class="form-group my-2"><label for="i-result">本頁網址</label><input class="form-control form-control-sm" type="text" :value="shortcut" ref="result" readonly></div><button class="btn btn-lg btn-secondary btn-block my-2" type="button" @click="btnCopy">複製本頁網址<br>(建議存在 LINE Keep 中)</button></div><div id="loading" v-if="page === 'loading'"><div class="text-center py-3">載入名片資料中，請稍候…</div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3/base64.min.js"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script><!-- bootstrap require jquery and pupper--><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="js/common.js?cachebust=1596130725364"></script><script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script><script>/* global decodeBase64url, getCsv */
window.gtagSetLineId()
const vm = new Vue({ // eslint-disable-line
  el: '#app',
  data: {
    error: null,
    page: 'loading',
    render: null,
    vcard: null,
  },
  async mounted () {
    try {
      await liff.init({ liffId: '1654437282-8ORYBGgE' })
      if (this.param('liff.state')) return await new Promise(resolve => {}) // 永遠不會結束的 Promise
      window.gtagScreenView('瀏覽分享名片網頁 CSV')
      window.gtagTiming('mounted start')
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: location.href })
        return await new Promise(resolve => {}) // 永遠不會結束的 Promise
      }
      window.gtagTiming('liff logined')
      await Promise.all([
        this.getTpl(),
        this.getVcard(),
      ])
      this.page = 'share'
      window.gtagTiming('mounted end')
    } catch (err) {
      console.error(err)
      this.handleError(err)
    }
  },
  computed: {
    shortcut () {
      return `https://liff.line.me/1654437282-8ORYBGgE/${new URL(location).search}`
    },
  },
  methods: {
    param (key) {
      const url = new URL(location)
      return url.searchParams.get(key)
    },
    paramBase64url (key) {
      const url = new URL(location)
      const base64 = url.searchParams.get(key)
      return base64 ? decodeBase64url(base64) : null
    },
    handleError (err) {
      window.gtagError(err, true)
      Swal.fire({
        icon: 'error',
        title: '發生錯誤',
        text: err.message,
      })
    },
    canSendMessages () {
      if (!liff.isInClient()) return false
      const contextType = _.get(liff.getContext(), 'type')
      if (!_.includes(['utou', 'room', 'group', 'square_chat'], contextType)) return false
      return true
    },
    getRenderedMsgs () {
      let msg = JSON5.parse(this.render({ vcard: this.vcard, _, Qs }))
      if (_.includes(['bubble', 'carousel'], _.get(msg, 'type'))) {
        msg = { type: 'flex', altText: '請在手機上查看數位版名片。', contents: msg }
      }
      if (!_.isArray(msg)) msg = [msg]
      console.log('msg =', JSON.stringify(msg))
      return msg
    },
    async getTpl () {
      try {
        const tpl = this.paramBase64url('template')
        if (!tpl) throw new Error('template is required.')
        this.render = _.template(_.get(await axios.get(tpl, {
          params: { cachebust: +new Date() },
          transformResponse: [],
        }), 'data'))
        if (!_.isFunction(this.render)) throw new Error('')
        window.gtagTiming('template loaded')
      } catch (err) {
        err.message = err.message ? `名片樣板獲取失敗: ${err.message}` : '名片樣板獲取失敗'
        this.render = null
        throw err
      }
    },
    async getVcard () {
      try {
        const args = _.fromPairs(_.map(['csv', 'key', 'value'], k => [k, this.paramBase64url(k)]))
        this.vcard = _.find(await getCsv(args.csv), [args.key, args.value])
        window.gtagTiming('vcard loaded')
      } catch (err) {
        err.message = err.message ? `名片資料獲取失敗: ${err.message}` : '名片資料獲取失敗'
        this.render = null
        throw err
      }
    },
    async btnShare () {
      try {
        window.gtagEvent('瀏覽分享名片網頁', 'btnShare', this.vcard.template)
        if (!liff.isApiAvailable('shareTargetPicker')) throw new Error('不支援 shareTargetPicker，請嘗試更新應用程式版本。')
        await liff.shareTargetPicker(this.getRenderedMsgs())
        Swal.fire({
          icon: 'success',
          title: '名片已分享',
        })
      } catch (err) {
        this.handleError(err)
      }
    },
    async btnSend () {
      try {
        window.gtagEvent('瀏覽分享名片網頁', 'btnSend', this.vcard.template)
        if (!this.canSendMessages()) throw new Error('沒有傳訊訊息的權限，請在聊天視窗內開啟。')
        await liff.sendMessages(this.getRenderedMsgs())
        Swal.fire({
          icon: 'success',
          title: '名片已傳送',
        })
      } catch (err) {
        this.handleError(err)
      }
    },
    async btnCopy () {
      window.gtagEvent('瀏覽分享名片網頁', 'btnCopy', this.vcard.template)
      const copyText = this.$refs.result
      copyText.select()
      copyText.setSelectionRange(0, 999999) // For mobile devices
      document.execCommand('copy')
      await Swal.fire({
        icon: 'success',
        title: '複製成功',
      })
    },
  },
})</script></body></html>